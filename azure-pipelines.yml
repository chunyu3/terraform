# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- script: echo Hello, world!
  displayName: 'Run a one-line script'

- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
  displayName: 'Run a multi-line script'
- bash: |
    git clone https://github.com/Azure/autorest.cli.git ~/autorest.cli
    cd ~/autorest.cli
    docker build --tag zikalino/autorest.cli.base -f Dockerfile-base .
    docker build --tag zikalino/autorest.cli .
  displayName: 'build docker image'
- bash: |
    git clone https://github.com/Azure/azure-rest-api-specs.git ~/azure-rest-api-specs
    git clone https://audevbot:${GH_TOKEN}@github.com/audevbot/autorest.cli.debug.git ~/autorest.cli.debug
    git clone https://audevbot:${GH_TOKEN}@github.com/Azure/magic-module-specs.git ~/magic-module-specs
    git clone https://chunyu3:${TF_TOKEN}@github.com/chunyu3/terraform.git ~/terraform
    cd ~/autorest.cli
    export CURRENT_PATH=$(pwd)
    echo ${CURRENT_PATH}
    ls ${CURRENT_PATH}/input
    cd ~/autorest.cli.debug; git checkout autogenerated-test -- ~/autorest.cli.debug || git checkout -B autogenerated-test
    mkdir -p ~/autorest.cli.debug/generated
    rm -rf ~/autorest.cli.debug/generated/*
    mkdir -p ~/mmoutput

    # 'cd ${CURRENT_PATH}/input;
    #    for d in *; do
    #       echo ---------------------------------------------------------------------------------;
    #       echo Processing: $d;
    #       echo ---------------------------------------------------------------------------------;
    #       docker run -t -i
    #       -v ~/azure-rest-api-specs:/azure-rest-api-specs
    #       -v ~/autorest.cli.debug/generated:/generated
    #       -v ~/magic-modules:/magic-modules
    #       -v ~/mmoutput:/mmoutput
    #       zikalino/autorest.cli
    #       /autorest.cli/input/$d;
    #       break;
    # done'
    for d in ${CURRENT_PATH}/input; do
      echo "Processing: $d";
      docker run -t -i -v ~/azure-rest-api-specs:/azure-rest-api-specs -v ~/autorest.cli.debug/generated:/generated -v ~/magic-modules:/magic-modules -v ~/mmoutput:/mmoutput zikalino/autorest.cli /autorest.cli/input/$d;
      break;
    done
  displayName: 'build magic-module input files'
- bash: |
    echo "success"
    cp -R ~/autorest.cli.debug/generated/magic-modules-input ~/terraform
    cp -R ~/mmoutput ~/terraform
    ls -al ~/terraform
    cd ~/terraform; git config credential.helper store
    echo "https://chunyu3:${TF_TOKEN}@github.com" > ~/.git-credentials
    cd ~/terraform; git add -A; git commit -m "autogenerated"; git push --set-upstream origin master;
  displayName: 'commit Magic-module input files'