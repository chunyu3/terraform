# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- script: echo Hello, world!
  displayName: 'Run a one-line script'

- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
    git clone https://github.com/chunyu3/autorest.cli.git ~/autorest.cli
    git clone -b azure_backend https://github.com/VSChina/magic-modules/ ~/magic-modules
    git clone https://chunyu3:${TF_TOKEN}@github.com/chunyu3/terraform.git ~/terraform
  displayName: 'clone git repo'
- bash: |
    #git clone https://github.com/Azure/autorest.cli.git ~/autorest.cli
    echo $(pwd)
    cd ~
    #export DOCKER_ACR_SERVER=terraformbuild.azurecr.io
    docker login ${DOCKER_ACR_SERVER} -u=${DOCKER_USER} -p=${DOCKER_PASSWORD}
    docker build --tag ${DOCKER_ACR_SERVER}/autorest.cli.base -f ~/terraform/Dockerfile-base .
    docker push ${DOCKER_ACR_SERVER}/autorest.cli.base
    docker build --tag ${DOCKER_ACR_SERVER}/autorest.cli --build-arg DOCKERSERVER=${DOCKER_ACR_SERVER} -f ~/terraform/Dockerfile .
    docker push ${DOCKER_ACR_SERVER}/autorest.cli
  displayName: 'build docker image'
  condition: eq(variables['build_image'], 'true')
- bash: |
    git clone https://github.com/Azure/azure-rest-api-specs.git ~/azure-rest-api-specs
    git clone https://audevbot:${GH_TOKEN}@github.com/audevbot/autorest.cli.debug.git ~/autorest.cli.debug
    git clone https://audevbot:${GH_TOKEN}@github.com/Azure/magic-module-specs.git ~/magic-module-specs
    # git clone https://chunyu3:${TF_TOKEN}@github.com/chunyu3/terraform.git ~/terraform
    cd ~/autorest.cli
    export CURRENT_PATH=$(pwd)
    echo ${CURRENT_PATH}
    ls ${CURRENT_PATH}/input
    cd ~/autorest.cli.debug; git checkout autogenerated-test -- ~/autorest.cli.debug || git checkout -B autogenerated-test
    mkdir -p ~/autorest.cli.debug/generated
    rm -rf ~/autorest.cli.debug/generated/*
    mkdir -p ~/mmoutput

    # 'cd ${CURRENT_PATH}/input;
    #    for d in *; do
    #       echo ---------------------------------------------------------------------------------;
    #       echo Processing: $d;
    #       echo ---------------------------------------------------------------------------------;
    #       docker run -t -i
    #       -v ~/azure-rest-api-specs:/azure-rest-api-specs
    #       -v ~/autorest.cli.debug/generated:/generated
    #       -v ~/magic-modules:/magic-modules
    #       -v ~/mmoutput:/mmoutput
    #       zikalino/autorest.cli
    #       /autorest.cli/input/$d;
    #       break;
    # done'
    # for d in ${CURRENT_PATH}/input/; do
    #   echo "Processing: $d";
    #   # docker run -t -i -v ~/azure-rest-api-specs:/azure-rest-api-specs -v ~/autorest.cli.debug/generated:/generated -v ~/magic-modules:/magic-modules -v ~/mmoutput:/mmoutput zikalino/autorest.cli /autorest.cli/input/$d;
    #   docker run -t -i -v ~/azure-rest-api-specs:/azure-rest-api-specs -v ~/autorest.cli.debug/generated:/generated -v ~/mmoutput:/mmoutput zikalino/autorest.cli /autorest.cli/input/$d;
    #   break;
    # done
    echo "docker run start"
    docker login ${DOCKER_ACR_SERVER} -u=${DOCKER_USER} -p=${DOCKER_PASSWORD}
    docker run -i -v ~/azure-rest-api-specs:/azure-rest-api-specs -v ~/autorest.cli.debug/generated:/generated -v ~/mmoutput:/mmoutput ${DOCKER_ACR_SERVER}/autorest.cli /autorest.cli/input
  displayName: 'build magic-module input files'
- bash: |
    echo "success"
    cp -R ~/autorest.cli.debug/generated/magic-modules-input ~/terraform
    # ls -al ~/mmoutput/azurerm
    cp -R ~/mmoutput ~/terraform
    # ls -aRl ~/terraform
    cd ~/terraform; git config credential.helper store ; git config --global user.email "yuchun_green@hotmail.com";git config --global user.name "chunyu3"
    echo "https://chunyu3:${TF_TOKEN}@github.com" > ~/.git-credentials
    cd ~/terraform; git add -A; git commit -m "autogenerated"; git push --set-upstream origin master;
  displayName: 'commit Magic-module input files'
  condition: always()
- bash: |
    echo "upload terraform code"
  displayName: 'upload terraform code'